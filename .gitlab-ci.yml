stages:
  - jhbuild-build
  - bootstrap
  - deploy
  
macos-deps:
  stage: jhbuild-build
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  before_script:
    - mkdir -p ~/project && mkdir -p ~/.config
    - cp -fv build/macOS/jhbuildrc-gtk-osx-siril ~/.config/jhbuildrc-custom || exit 1
    - cp -Rf build/macOS/modulesets ~/project/ || exit 1
    - cp -Rf build/macOS/patches ~/project/ || exit 1
    - cp -fv build/macOS/gtk-osx-setup.sh ~/project/gtk-osx-setup.sh || exit 1
  script:
    - ./build/macOS/010-install_python.sh 1>/dev/null
    - ./build/macOS/020-install_SDK.sh 1>/dev/null
    - ./build/macOS/100-setup_jhbuild.sh 1>/dev/null
    - ./build/macOS/110-setup_gtk_mac_bundler.sh 1>/dev/null
  after_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context build/build-image/ --dockerfile build/build-image/Dockerfile.jhbuild --destination $CI_REGISTRY_IMAGE:build-jhbuild --cache=true --cache-ttl=120h

      
macos-bootstrap:
  stage: bootstrap
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  script:
    - ./build/macOS/120-bootstrap.sh 1>/dev/null
  after_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context build/build-image/ --dockerfile build/build-image/Dockerfile.bootstrap --destination $CI_REGISTRY_IMAGE:build-bootstrap --cache=true --cache-ttl=120h
  needs: ["build-jhbuild"]
          
macos-siril:
  stage: deploy
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  dependencies:
    - macos-deps
    - macos-bootstrap
  before_script:
    - source ~/.profile && jhbuild build $(jhbuild info siril|grep '^Requires:'|sed -e 's|^Requires:||' -e 's|gegl||'|tr -d ',')
    - find  ~/gtk/source -type d -mindepth 1 -maxdepth 1 | xargs -I% rm -rf %/*
  script:
    - jhbuild build siril
  needs: ["build-bootstrap"]
  