 macos-build:
  except:
    - schedules
  stage: build
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  before_script:
    - cd ~/
    - curl -L 'https://www.python.org/ftp/python/3.9.7/python-3.9.7-macos11.pkg' > python-3.9.7-macosx11.pkg
    - sudo installer -pkg python-3.9.7-macosx11.pkg -target /
    # Certificates are outdated, most likely after the recent
    # Let's Encrypt root certs fiasco. This fixes it by
    # updating the certs.
    - open /Applications/Python\ 3.9/Install\ Certificates.command
    - cd /Library/Developer/CommandLineTools/SDKs
    - sudo curl -L 'https://github.com/phracker/MacOSX-SDKs/releases/download/10.15/MacOSX10.12.sdk.tar.xz' | sudo tar -xzf -
    - echo 'export SDKROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX10.12.sdk' > ~/.profile
    - echo 'export MACOSX_DEPLOYMENT_TARGET=10.12' >> ~/.profile
    - cd $HOME
    - mkdir -p ~/.config && cp ~/project/jhbuildrc-gtk-osx-gimp-2.99 ~/.config/jhbuildrc-custom
    - curl https://gitlab.gnome.org/samm-git/gtk-osx/raw/gimp/gtk-osx-setup.sh > gtk-osx-setup.sh
    - chmod +x gtk-osx-setup.sh
    - echo 'export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH:$HOME/.new_local/bin"' >> ~/.profile
    - echo 'export ARCHFLAGS="-arch x86_64"' >> ~/.profile
    # PYTHON variable seems to be incorrectly set
    - echo 'export PYTHON=/Library/Frameworks/Python.framework/Versions/3.9/bin/python3' >> ~/.profile
    # Unclear why this is needed, but if missing, jhbuild fails in some circumstances
    - echo 'export PYENV_VERSION="3.9.7"' >> ~/.profile
    - source ~/.profile
    - PIPENV_YES=1 ./gtk-osx-setup.sh
    - $HOME/.new_local/bin/jhbuild bootstrap-gtk-osx-gimp
    - cat ~/.profile
  script:
    - echo 'Done'
  artifacts:
    expire_in: 1 week
    paths:
      - ~/.new_local
      - ~/gtk
      - ~/.config
