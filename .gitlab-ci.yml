stages:
  - jhbuild-build
  - bootstrap
  - deploy
  
macos-deps:
  stage: jhbuild-build
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  before_script:
    - echo "$(ls -alh)"
    - mkdir -p ~/project && mkdir -p ~/.config
    - cd build/macOS/ || exit 1
    - cp -fv jhbuildrc-gtk-osx-siril ~/.config/jhbuildrc-custom || exit 1
    - cp -Rf modulesets ~/project/ || exit 1
    - cp -Rf patches ~/project/ || exit 1
    - cp -fv gtk-osx-setup.sh ~/project/gtk-osx-setup.sh || exit 1
  script:
    - ./010-install_python.sh 1>/dev/null
    - ./020-install_SDK.sh 1>/dev/null
    - ./100-setup_jhbuild.sh 1>/dev/null
    - ./110-setup_gtk_mac_bundler.sh 1>/dev/null
  cache:
    key: setup-v1
    paths:
      - ~/.new_local
      - ~/gtk
      - ~/.config
      
macos-bootstrap:
  stage: bootstrap
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  before_script:
    - cd build/macOS/ || exit 1
  script:
    - ./120-bootstrap.sh 1>/dev/null
  cache:
    key: setup-v1
    paths:
      - ~/.new_local
      - ~/gtk
      - ~/.config
          
macos-siril:
  stage: deploy
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12 # https://docs.gitlab.com/ee/ci/runners/build_cloud/macos/environment.html
  dependencies:
    - macos-deps
    - macos-bootstrap
  before_script:
    - source ~/.profile && jhbuild build $(jhbuild info siril|grep '^Requires:'|sed -e 's|^Requires:||' -e 's|gegl||'|tr -d ',')
    - find  ~/gtk/source -type d -mindepth 1 -maxdepth 1 | xargs -I% rm -rf %/*
  script:
    - jhbuild build siril
  cache:
    key: setup-v1
    paths:
      - ~/.new_local
      - ~/gtk
      - ~/.config
